<!--
* IBM Confidential
* OCO Source Materials
* 5737-D18, 5725-D10
*
* (C) Copyright International Business Machines Corp. 2021, 2024
*
* The source code for this program is not published or otherwise divested
* of its trade secrets, irrespective of what has been deposited with the
* U.S. Copyright Office.
-->

<ibm-modal [size]="modalData.size" [open]="open" [hasScrollingContent]="false">
    <ibm-modal-header (closeSelect)="onCloseModalClick()" [attr.tid]="componentId + 'ibm-modal-header'">
        <span>{{ (isResourceAllowedToAddChangeOrderCharges ? 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_ADJUST_PRICING': 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_VIEW_PRICING') | translate }}</span>
        <span *ngIf="isLineLevel"> {{ 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_ONE_LINE' | translate }}</span>
        <ng-container *ngIf="isResourceAllowedToAddChangeOrderCharges">
            <button class="tooltip-btn" [attr.tid]="componentId + 'headerButton'"></button>
            <cds-tooltip class="info-toolip" [description]="tooltipTemplate" trigger="hover" [align]="'bottom'" [autoAlign]="'true'" [attr.tid]="componentId + 'hToolTip'">
                <svg ibmIcon="information" size="16" class=""></svg>
            </cds-tooltip>
        </ng-container>
    </ibm-modal-header>

    <section class="cds--modal-content adjust-pricing-modal-section" [attr.tid]="componentId + '-modal-content'">
        <ng-template bucExtension [componentName]="componentId" [placement]="'top'" [id]="EXTENSION.TOP" [parent]="this">
        </ng-template>
    <div class="modalNotification set-pos" *ngIf="notificationShown" style="padding-top: 1.5rem;">
        <buc-notification [attr.tid]="componentId + '-adjust-pricining-notification'" [notificationObj]="notificationObj" (click)="closeNotification()"></buc-notification>
    </div>
    <div class="cds--grid cds--no-gutter" [ngClass]="notificationShown?'mtop3rem':'mtop0_5rem'" >
            <div *ngIf="!isSaveAllChargesEnabled && !isLineLevel && isResourceAllowedToAddChangeOrderCharges" [attr.tid]="componentId + 'order-table'">
                <call-center-adjust-pricing-order-table
                [selectedOrder]="[summaryDetails]">
                </call-center-adjust-pricing-order-table>
            </div>
            <div *ngIf="!isSaveAllChargesEnabled && isLineLevel && isResourceAllowedToAddChangeOrderCharges" [attr.tid]="componentId + 'order-line-table'">
                <call-center-adjust-pricing-line-table
                [selectedOrderLines]="selectedOrderLines">
                </call-center-adjust-pricing-line-table>
            </div>

            <div class="cds--row" [ngClass]="isSaveAllChargesEnabled ? '' : 'margin-top--2_5rem'" *ngIf="!isLineLevel" [attr.tid]="componentId + 'promotion-box'">
                <!--OMS--78847--Start-->
                <call-center-promotion-box extn [appliedCouponPromo]="appliedCouponPromo" [orderHeaderKey]="orderHeaderKey"  [recordPendingChangesMode]="isSaveAllChargesEnabled ? false : true" [isModal]="true"
                    (callGetOrderDetails)="getOrderDetails($event)" [isDraftOrder] ="isDraftOrder"
					 (promoUpdated)="promoUpdated()"
                    (promoError)="onPromoError($event)" [isSaveAllChargesEnabled]="isSaveAllChargesEnabled"
                (callSetFlags)="setFlags($event)" [allowedModifications]="allowedModifications" [enterpriseCode]="summaryDetails.EnterpriseCode">
                </call-center-promotion-box>
                <!--OMS--78847--End-->
            </div>
            <br>

            <div class="margin-top--2rem adjust-pricing-table" [attr.tid]="componentId + 'chargesTable'">
                <buc-table
                    [attr.tid]="'buc-adjust-pricing-modal.table'"
                    [defaultPageLen]="defaultPageLen"
                    [model]="model"
                    [skeleton]="model.isLoading"
                    [paginationTranslations]="paginationTranslations"
                    [showEmptyState]="false"
                    [showSelectionColumn]="false"
                    [size]="'sm'">
                    <buc-empty-state *ngIf="!model.isLoading && model.totalDataLength === 0"
                        [stateMessage]="'ORDER_SUMMARY.ADJUST_PRICING_MODAL.NO_DATA_MESSAGE' | translate">
                    </buc-empty-state>
                </buc-table>
            </div>
            <ng-container *ngIf="isResourceAllowedToAddChangeOrderCharges">
                <div style="display:flex; ">
                    <buc-button #b type="ghost" [attr.tid]="componentId + 'addChargeBtn'" btnSize="sm" [isDisabled]="!isResourceAllowedToAddChangeOrderCharges|| !isChargeModificationPermissionAllowed()"  (click)="addNewChargeRow()">{{ 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_ADD_ADJUSTMENT' | translate }}
                        <svg ibmIcon="add" size="16" [attr.tid]="componentId + '-add-icon'" class="addBtn cds--btn__icon"></svg>
                    </buc-button>
                    <div *ngIf="!isChargeModificationPermissionAllowed()">
                        <button class="tooltip-btn" [attr.tid]="componentId + 'btnTooltip'" ></button>
                        <cds-tooltip class="info-disable" [description]="disableInfoTemplate" trigger="hover" [align]="'right'" [autoAlign]="'true'" >
                        <svg ibmIcon="information" size="16" class=""></svg>
                        </cds-tooltip>
                    </div>
                </div>
            </ng-container>

        <div class="cds--row margin-top--2_5rem" *ngIf="showManagerIDField && hasOverrideError">
            <div class="cds--col-lg-5 margin-bottom--0_5rem">
            <buc-label
                type="password"
                [isInvalid]="invalidManagerID"
                [invalidText]="'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.INVALID_MANAGER_ID' | translate"
                [(inputValue)]="managerID"
                [label]="'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_MANAGER_ID' | translate"
                placeholder="">
            </buc-label>
            </div>

            <div class="cds--col-lg-5 margin-top--1_5rem">
            <button class="height_2rem cds--btn cds--btn--primary" (click)="onManagerIDChange()" [attr.tid]="componentId + 'applybtn'">
                {{ 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_APPLY' | translate }}
            </button>
            </div>

        </div>
        <ng-container *ngIf="isResourceAllowedToAddChangeOrderCharges">
            <div class="margin-top--2_5rem required-note-field">
                <buc-textarea [(inputValue)]="note" rows="2" [attr.tid]="componentId + 'noteTextArea'"
                    maxlength="800"
                    [label]="'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_NOTE' | translate"
                    (inputValueChange)="onNoteChange()"
                    >
                </buc-textarea>
            </div>
        </ng-container>
        </div>

        <ng-template #tooltipTemplate let-tooltip="$implicit">
            <div class="adjust-pricing-modal-tooltip">
            <div class="cds--label" [attr.tid]="componentId + 'tooltipInfo'">
                {{(isLineLevel ? 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.MSG_TOOLTIP_ORDER_LINE' : 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.MSG_TOOLTIP_ORDER') | translate}}
            </div>
            </div>
        </ng-template>
    
        <ng-template #tooltipNameTemplate let-tooltip="$implicit">
            <div class="adjust-pricing-modal-tooltip">
            <div class="cds--label" [attr.tid]="componentId + 'tooltipInfo'">
                {{ tooltip.data.discountLabel | translate}}
            </div>
            </div>
        </ng-template>
    
        <ng-template #disableInfoTemplate let-tooltip="$implicit">
            <div class="adjust-pricing-modal-tooltip">
            <div class="cds--label" [attr.tid]="componentId + 'noActionTooltip'">
                {{'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_ACTION_NOT_AVAILABLE' | translate}}
            </div>
            </div>
        </ng-template>
    
        <ng-template #chargeName let-data="data" >
            <ng-container *ngIf="!data.newRow" >{{data.value}}</ng-container>
            <buc-dropdown *ngIf="data.newRow" [items]="data.chargeNameList" [attr.tid]="componentId + 'chargeName'"
                [disabled]="data.isDisable"
                (selected)="changeInChargeNameList($event,data.index)">
            </buc-dropdown>
        </ng-template>
    
        <ng-template #chargeApplyTo let-data="data" >
            <ng-container *ngIf="!data.newRow" >{{data.value}}</ng-container>
                <div *ngIf="data.newRow">
                    <p>{{'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_CHARGE_PER_UNIT'| translate}}</p>
                </div>
        </ng-template>
    
        <ng-template #chargeType let-data="data" >
            <ng-container *ngIf="!data.newRow" >{{data.value}}</ng-container>
                <div class="order-wrapper margin-top--0-5rem" *ngIf="data.newRow">
                    <buc-radio
                        class="padding-right--1rem"
                        [isChecked]="selectedChargeType === 'shipping'"
                        (change)="changeInChargeType('shipping',data.index)">
                        {{ 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_BILLABLE' | translate }}
                    </buc-radio>
                    
                    <buc-radio
                        class="padding-right--1rem"
                        [isChecked]="selectedChargeType === 'discount'"
                        (change)="changeInChargeType('discount',data.index)">
                        {{ 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_DISCOUNT' | translate }}
                    </buc-radio>
                </div>
        </ng-template>

        <ng-template #chargeCategory let-data="data" >
            <ng-container *ngIf="!data.newRow" >{{data.value}}</ng-container>
                <buc-dropdown *ngIf="data.newRow" [items]="data.categoryTypeList" [attr.tid]="componentId + 'chargeCategory'"
                    [disabled]="data.isDisable">
                </buc-dropdown>
 
        </ng-template>
    
        <ng-template #amount let-data="data" >
            <div class="parentAmount" [ngClass]="!currencySymbolBefore ? 'reverse' : 'normal'">
                <span class="currencyStyling" [ngClass]="!currencySymbolBefore ? 'width--30' : 'width--unset'">{{ null | bucCommonCurrencyFmt: summaryDetails?.PriceInfo.Currency: 'symbol' }}</span>
                <!-- <ibm-label class="labelStyle">
                    <input  [attr.tid]="componentId + 'amount'"
                        ibmText
                        bucNumericValuesOnly
                        [disabled]="data.isDisable"
                        [theme]="'dark'"
                        [(ngModel)]="data.value"
                        (ngModelChange)="changeInAmountField(data, $event)">
                </ibm-label> -->
                <buc-number-ext class="labelStyle"
                    [tagId]="componentId + 'amount'"
                    [isDisabled]="data.isDisable"
                    [theme]="'dark'"
                    [stepButtonEnabled]="false"
                    [curLocale]="curLocale"
                    [(value)]="data.value"
                    [validationType]="'decimal'"
                    (invalidNumber)="changeInAmountField(data, undefined)"
                    [displayValue]="data.displayValue"
                    (displayChange)="onDisplayChange(data, $event)"
                    (change)="changeInAmountField(data, $event)">
                </buc-number-ext>
            </div>
        </ng-template>

        <ng-template #chargePercentage let-data="data">
            <div class="parentAmount">
                
                <buc-number-ext class="labelStyle"
                    [tagId]="componentId + 'percentOff'"
                    [isDisabled]="data.isDisable"
                    [theme]="'dark'"
                    [stepButtonEnabled]="false"
                    [curLocale]="curLocale"
                    [invalidText]="invalidMessage | translate"
                    [(value)]="data.value"
                    [validationType]="'decimal'"
                    (invalidNumber)="extnChangeInPercentOffField(data, undefined)"
                    [displayValue]="data.displayValue"
                    (displayChange)="onDisplayChange(data, $event)"
                    (change)="extnChangeInPercentOffField(data, $event)">
                </buc-number-ext>
                <span class="currencyStyling" [ngClass]="width--unset">%</span>            </div>
        </ng-template>
    
        <ng-template #chargeTypeReadOnly let-data="data" [attr.tid]="componentId + 'chargeTypeReadOnly'">
            {{data.value}}
        </ng-template>
    
        <ng-template #chargeNameReadOnly let-data="data" [attr.tid]="componentId + 'chargeNameReadOnly'">
            {{data.value}}
            <cds-tooltip *ngIf="data.discountLabel"class="tooltip-justify" [description]="tooltipNameTemplate"  [templateContext]="data" trigger="hover" [align]="'right'" [autoAlign]="'true'" [attr.tid]="componentId + 'hToolTip'">
                <svg ibmIcon="information" size="16" class=""></svg>
            </cds-tooltip>
        </ng-template>
    
        <ng-template #chargeApplyToReadOnly let-data="data" [attr.tid]="componentId + 'chargeApplyToReadOnly'">
            {{data.value}}
        </ng-template>
		
		<ng-template #chargePercentageReadOnly
			let-data="data" [attr.tid]="componentId + 'chargePercentageReadOnly'">
			<span></span>{{data.value}}
		</ng-template>
    
        <ng-template #amountReadOnly let-data="data" [attr.tid]="componentId + 'amountReadOnly'">
            <span>{{ data.value | bucCommonCurrencyFmt: summaryDetails?.PriceInfo.Currency: 'symbol' }}</span>
        </ng-template>

        <ng-template #removeActionTemplateRef let-data="data">
            <div *ngIf="data?.newRow" class="icon-style">
                <span>
                    <svg ibmIcon="trash-can" [attr.tid]="componentId + '-delete-icon'" size="16" role="button"
                        (click)="chargeRemoveAction(data.index)">
                    </svg>
                </span>
            </div>
        </ng-template>
        <ng-template bucExtension [componentName]="componentId" [placement]="'bottom'" [id]="EXTENSION.BOTTOM" [parent]="this">
        </ng-template>
    </section>

    <ibm-modal-footer>
        <button class="cds--btn cds--btn--secondary" (click)="onCloseModalClick()" [attr.tid]="componentId + 'btnCancel'">
            {{ (isDraftOrder || !isResourceAllowedToAddChangeOrderCharges ? 'ORDER_PRICING_SUMMARY.ADJUST_PRICING_MODAL.LABEL_CLOSE' : 'ORDER_SUMMARY.SHARED.LABEL_CANCEL') | translate }}
        </button>
        <ng-container *ngIf="isResourceAllowedToAddChangeOrderCharges">
        <button class="cds--btn cds--btn--primary" (click)="onSaveClick()" [disabled]="!saveChargesEnabled || invalidManagerID || hasOverrideError" [attr.tid]="componentId + 'btnSave'">
            {{ 'ORDER_SUMMARY.SHARED.LABEL_SAVE' | translate }}
        </button>
        </ng-container>
    </ibm-modal-footer>


</ibm-modal>
